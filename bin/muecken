#!/usr/bin/env ruby

#
# THIS IS A TEST SCRIPT, MEANT FOR DEVELOPMENT USAGE ONLY
#

require 'muecken'
require 'optparse'

# define options
opts = OptionParser.new do |o|
  o.banner = 'Muecken: a Ruby library to parse and analyze financial data.'
  o.define_head 'Usage: bundle exec muecken <input_file>'
  o.separator ''
  o.separator 'Examples:'
  o.separator ' bundle exec bin/muecken tmp/test-data.csv'
  o.separator ''
  o.separator 'Options:'
  o.on_tail('-?', '--help', 'Show this message') { puts o; exit 1 }
  o.on_tail('-v', '--version', 'Show version') { puts Muecken::VERSION; exit 0 }
end
opts.parse!

# check if file exists
file_name = ARGV.shift
if file_name.to_s.strip.empty? || !File.exist?(file_name.to_s)
  puts opts
  exit 1
end

# create engine
engine = Muecken::Engine.new

# setup rules
engine.rules = Muecken::Rules::Builder.month_rules
engine.add_rule Muecken::Rules::Builder.year_rule(2013)
engine.add_rule Muecken::Rules::Builder.year_rule(2014)

# load entries
entries = Muecken::Parser::CSV.read_file(file_name)

# categorize entries
entries.each do |entry|
  engine.categorize_entry(entry)
  engine.add_entry(entry)
end

# print each category and it's entries
engine.categories.each do |category|
  puts "\n -- #{category.name} -- \n"
  engine.by_category(category).each do |entry|
    puts entry
  end
end

exit 0
